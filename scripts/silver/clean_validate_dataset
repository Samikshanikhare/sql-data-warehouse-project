USE candy_sales_analysis;

--cleans and validates the bronze.candy_sales table 
/* 
Cleansing done:

    Removed duplicates

    Trimmed spaces

    Handled nulls

    Ensured positive Sales and Units */

IF OBJECT_ID('silver.candy_sales_clean', 'U') IS NOT NULL 
    DROP TABLE silver.candy_sales_clean;

SELECT DISTINCT
    CAST([Order Date] AS DATE) AS Order_Date,
    CAST([Ship Date] AS DATE) AS Ship_Date,
    LTRIM(RTRIM([Order ID])) AS Order_ID,
    [Customer ID] AS Customer_ID,
    LTRIM(RTRIM([Country/Region])) AS Country_Region,
    LTRIM(RTRIM([City])) AS City,
    LTRIM(RTRIM([State/Province])) AS State_Province,
    LTRIM(RTRIM([Postal Code])) AS Postal_Code,
    LTRIM(RTRIM([Division])) AS Division,
    LTRIM(RTRIM([Region])) AS Region,
    LTRIM(RTRIM([Product ID])) AS Product_ID,
    LTRIM(RTRIM([Product Name])) AS Product_Name,
    COALESCE([Sales], 0) AS Sales,
    COALESCE([Units], 0) AS Units,
    COALESCE([Gross Profit], 0) AS Gross_Profit,
    COALESCE([Cost], 0) AS Cost
INTO silver.candy_sales_clean
FROM bronze.Candy_Sales
WHERE [Sales] > 0 AND [Units] > 0;


--candy_factories_clean
--Geographical standardization of factory locations
/*
Cleansing done:

    Trim factory names

    Remove invalid coordinates

    Round lat-long to standard 6 decimals */

-- Drop table first if it already exists
IF OBJECT_ID('silver.candy_factories_clean', 'U') IS NOT NULL 
    DROP TABLE silver.candy_factories_clean;

-- Create and populate the cleaned table
SELECT DISTINCT
    LTRIM(RTRIM(Factory)) AS Factory,
    ROUND(Latitude, 6) AS Latitude,
    ROUND(Longitude, 6) AS Longitude
INTO silver.candy_factories_clean
FROM bronze.candy_factories
WHERE Latitude IS NOT NULL 
  AND Longitude IS NOT NULL;


  --candy_product_clean
  --Ensures pricing consistency and valid factory links.
  /*
  Cleansing done:

    Trim text

    Ensure valid prices

    Added computed column Profit_Per_Unit
  */
IF OBJECT_ID('silver.candy_product_clean', 'U') IS NOT NULL 
    DROP TABLE silver.candy_product_clean;

SELECT DISTINCT
    LTRIM(RTRIM(Product_ID)) AS Product_ID,
    LTRIM(RTRIM(Product_Name)) AS Product_Name,
    LTRIM(RTRIM(Division)) AS Division,
    LTRIM(RTRIM(Factory)) AS Factory,
    CAST(Unit_Price AS DECIMAL(10,2)) AS Unit_Price,
    CAST(Unit_Cost AS DECIMAL(10,2)) AS Unit_Cost,
    (Unit_Price - Unit_Cost) AS Profit_Per_Unit
INTO silver.candy_product_clean
FROM bronze.candy_product
WHERE Unit_Price > 0 AND Unit_Cost > 0;


--candy_targets_clean
--Aligns targets with standardized division names.
/*
Cleansing done:

    Removed invalid target entries

    Trimmed names
*/
IF OBJECT_ID('silver.candy_targets_clean', 'U') IS NOT NULL 
    DROP TABLE silver.candy_targets_clean;

SELECT DISTINCT
    LTRIM(RTRIM(Division)) AS Division,
    Target
INTO silver.candy_targets_clean
FROM bronze.candy_targets
WHERE Target > 0;



--candy_sales_supply_join
--A master table combining all cleaned sources for Gold analytics
/*
Enrichment done:

    Joined all key business entities

    Ready for Power BI (Gold layer)
*/
IF OBJECT_ID('silver.candy_sales_supply_join', 'U') IS NOT NULL 
    DROP TABLE silver.candy_sales_supply_join;

SELECT 
    s.Order_ID,
    s.Order_Date,
    s.Ship_Date,
    s.Region,
    s.Country_Region,
    s.State_Province,
    s.City,
    s.Postal_Code,
    s.Division,
    p.Product_Name,
    p.Unit_Price,
    p.Unit_Cost,
    p.Profit_Per_Unit,
    s.Sales,
    s.Units,
    s.Gross_Profit,
    s.Cost,
    f.Factory,
    f.Latitude,
    f.Longitude,
    t.Target
INTO silver.candy_sales_supply_join
FROM silver.candy_sales_clean AS s
LEFT JOIN silver.candy_product_clean AS p
    ON s.Product_ID = p.Product_ID
LEFT JOIN silver.candy_factories_clean AS f
    ON p.Factory = f.Factory
LEFT JOIN silver.candy_targets_clean AS t
    ON s.Division = t.Division;
